<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <title>Poulallier de la grotte // Live streaming</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
            data-target="#navbarCollapse" aria-controls="navbarCollapse"
            aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="#home">Poulallier Grotte</a>
    <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav mr-auto">
            <!--<li class="nav-item">
                <a class="nav-link" href="#cam">Caméra</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#state">Etat</a>
            </li>-->
        </ul>
    </div>
</nav>

<div class="container">

    <h1 class="header" id="home">Poulallier connecté de la Grotte 2018</h1>

    <h3 class="header" id="cam">Live stream</h3>

    <div class="row">

        <div class="col-8 offset-2" id="cam_iframe">

        </div>
    </div>

    <h3 class="header" id="door">Porte</h3>
    <div class="row">
        <div class="col-4">
            <code id="door_state"></code>
        </div>
        <div class="col-4">
            <div id="door_actions">
            </div>
        </div>
        <div class="col-4">
            <code id="door_msg"></code>
        </div>
    </div>
    <h3 class="header" id="led">LED</h3>
    <div class="row">
        <div class="col-4">
            <code id="led_state"></code>
        </div>
        <div class="col-4">
            <div id="led_actions">
                <a href="#" class="btn btn-primary action_button" data-action="LED" data-msg="led_msg">Allumer/eteindre les LED</a>
            </div>
        </div>
        <div class="col-4">
            <code id="led_msg"></code>
        </div>
    </div>

    <h3 class="header" id="state">Etat</h3>
    <div class="row">
        <div class="col-12">
            <code id="state_txt">
            </code>
        </div>
    </div>


</div> <!-- /container -->

<footer class="footer text-muted">
    <div class="container">
        <p>License <a rel="license" href="https://github.com/as-eldlc/chicken_coop/blob/master/LICENSE" target="_blank">GPL</a>.
    </div>
</footer>

<!-- Libraries -->
<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/tether.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/modernizr.js"></script>
<script src="js/moment-with-locales.js"></script>

<script type="text/javascript">
    function update_state() {
        $.get("http://" + domain + "/coop/get_state.php", function (data) {
            if (data.length > 10){
                $("#state_txt").html(data);
                var res = data.split("//");
                res.forEach(function(e){
                    console.log(e);
                    if (e.search("DOOR: ") >= 0){
                        var s = e.replace("DOOR: ","");
                        $("#door_state").html(s);
                        if (s == "OPENED"){
                            $("#door_actions").html('<a href="#" class="btn btn-primary naction_button" data-action="CLOSE" data-msg="door_msg">FERMER</a>');
                        } else if (s == "CLOSED"){
                            $("#door_actions").html('<a href="#" class="btn btn-primary naction_button" data-action="OPEN" data-msg="door_msg">OUVRIR</a>');
                        } else if (s == "IDLE"){
                            $("#door_actions").html('<a href="#" class="btn btn-primary naction_button" data-action="CLOSE" data-msg="door_msg">FERMER</a>' +
                            '<a href="#" class="btn btn-primary naction_button" data-action="OPEN" data-msg="door_msg">OUVRIR</a>');

                        }
                    } else if (e.search("LED: ") >= 0){
                        var s = e.replace("LED: ","");
                        $("#led_state").html(s);
                    }
                });
                reload_actions();
            }
        })
    }

    function hdl(e) {
        e.preventDefault();
        var a = $(e.target).attr("data-action");
        var b = $(e.target).attr("data-msg");
        $("#"+b).html("en cours...");
        $.get("http://" + domain + "/coop/emulate_button.php?button=" + a + "", function (data) {
            $("#"+b).html("OK");
        });
    }

    function reload_actions(){
        $(".naction_button").click(hdl);
    }

    var domain = "";
    $(function () {
        domain = window.location.hostname;
        $("#cam_iframe").html("<iframe src=\"http://" + domain + ":8081\" width=\"650\" height=\"490\"></iframe>");
        t = setInterval(update_state, 1000);
        $(".action_button").click(hdl);
    });
</script>

</body>

</html>
